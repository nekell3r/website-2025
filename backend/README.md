# Веб-сайт [Укажите Название Вашего Проекта/Курса] - Backend

Этот проект представляет собой бэкенд-приложение для веб-сайта [Ваше Название], разработанное на Python с использованием фреймворка FastAPI. Приложение обеспечивает аутентификацию пользователей, управление курсами/продуктами, систему отзывов, интеграцию с платежной системой ЮKassa и другие функции.

## Основные технологии

*   **Язык программирования**: Python 3.11+
*   **Фреймворк**: FastAPI
*   **База данных**: PostgreSQL (асинхронное взаимодействие через `asyncpg`)
*   **Миграции БД**: Alembic
*   **Кэширование**: Redis (`fastapi-cache`)
*   **Валидация данных**: Pydantic
*   **Управление зависимостями**: Poetry
*   **Аутентификация**: JWT (access и refresh токены в cookies)
*   **Платежная система**: ЮKassa (интеграция для обработки платежей)
*   **Отправка SMS**: Интеграция с SMS.ru (для кодов подтверждения)
*   **Тестирование**: Pytest, `pytest-asyncio`, `pytest-dotenv`

## Функционал

*   Регистрация пользователей (по номеру телефона или email с подтверждением кодом).
*   Аутентификация пользователей (логин/пароль, JWT токены).
*   Обновление токенов (refresh token).
*   Сброс пароля (по номеру телефона или email с подтверждением кодом).
*   Управление информацией о пользователе (личный кабинет).
*   Административная панель для управления пользователями (базовые функции).
*   Управление продуктами/курсами (CRUD операции для администраторов).
*   Система отзывов о продуктах/курсах.
*   Интеграция с платежной системой ЮKassa для создания и обработки платежей.
*   Обработка вебхуков от ЮKassa для обновления статусов платежей.

## Структура проекта

*   `src/`: Основной исходный код приложения.
    *   `api/`: Роутеры FastAPI, определяющие эндпоинты.
    *   `config.py`: Конфигурация приложения (загрузка из переменных окружения).
    *   `database.py`: Настройка подключения к базе данных.
    *   `dependencies/`: Зависимости FastAPI (например, для аутентификации, получения сессии БД).
    *   `exceptions/`: Кастомные классы исключений и их обработчики.
    *   `models/`: ORM-модели SQLAlchemy для таблиц базы данных.
    *   `repositories/`: Классы-репозитории для взаимодействия с базой данных (абстракция над ORM).
    *   `schemas/`: Pydantic-схемы для валидации данных запросов и ответов.
    *   `services/`: Бизнес-логика приложения.
    *   `utils/`: Вспомогательные утилиты.
    *   `main.py`: Точка входа в приложение FastAPI.
    *   `init.py`: Инициализация внешних сервисов (Redis, Yookassa).
*   `migrations/`: Файлы миграций Alembic.
    *   `versions/`: Сгенерированные миграции.
    *   `env.py`: Конфигурация Alembic.
*   `tests/`: Тесты для приложения.
    *   `unit_tests/`: Модульные тесты.
    *   `integration_tests/`: Интеграционные тесты.
*   `alembic.ini`: Конфигурационный файл Alembic.
*   `Dockerfile`: Файл для сборки Docker-образа приложения.
*   `docker-compose.yml`: (Рекомендуется создать) Файл для оркестрации контейнеров (приложение, БД, Redis).
*   `.local_env_example`: Пример файла с переменными окружения для локальной разработки.
*   `.env-test`: Переменные окружения для тестов.
*   `pyproject.toml` и `poetry.lock`: Файлы управления зависимостями Poetry.
*   `pytest.ini`: Конфигурация Pytest.

## Установка и запуск

### Требования

*   Python 3.11 или выше.
*   Poetry (менеджер зависимостей). Инструкции по установке: [https://python-poetry.org/docs/#installation](https://python-poetry.org/docs/#installation)

### Локальный запуск

1.  **Клонируйте репозиторий:**
    ```bash
    git clone <URL_ВАШЕГО_РЕПОЗИТОРИЯ>
    cd <НАЗВАНИЕ_ДИРЕКТОРИИ_ПРОЕКТА>
    ```

2.  **Установите зависимости:**
    ```bash
    poetry install
    ```
    Эта команда создаст виртуальное окружение (если его нет) и установит все необходимые пакеты.

3.  **Настройте переменные окружения:**
    *   Скопируйте файл `.local_env_example` в новый файл с именем `.local_env_example` (да, имя тоже самое, так как `src/main.py` сейчас настроен на чтение именно этого файла для локального запуска, если `MODE=LOCAL` или `MODE` не установлен).
        ```bash
        cp .local_env_example .local_env_example 
        ```
        ИЛИ, если вы хотите использовать стандартный `.env` для локального запуска, скопируйте в `.env` и измените `src/main.py`, чтобы он читал `.env` при `MODE=LOCAL`.
    *   Откройте созданный файл (`.local_env_example` или `.env`) и отредактируйте значения переменных:
        *   `MODE=LOCAL`
        *   `DB_USER`, `DB_PASS`, `DB_NAME`, `DB_HOST`, `DB_PORT`: Данные для подключения к вашему локальному PostgreSQL.
        *   `REDIS_HOST`, `REDIS_PORT`: Данные для подключения к вашему локальному Redis.
        *   `JWT_SECRET_KEY`, `JWT_REFRESH_SECRET_KEY`: Сгенерируйте надежные случайные строки.
        *   `YOOKASSA_SHOP_ID`, `YOOKASSA_SECRET_KEY`: Ваши тестовые или боевые ключи ЮKassa.
        *   `SMSRU_API_ID`: Ваш API ID для SMS.ru.

4.  **Убедитесь, что PostgreSQL и Redis запущены** и доступны по указанным в переменных окружения адресам.

5.  **Примените миграции базы данных:**
    Активируйте виртуальное окружение Poetry, если вы еще не в нем:
    ```bash
    poetry shell
    ```
    Запустите миграции:
    ```bash
    alembic upgrade head
    ```

6.  **Запустите приложение FastAPI:**
    ```bash
    uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
    ```
    Приложение будет доступно по адресу `http://localhost:8000`.

### Запуск с использованием Docker (рекомендуется)

1.  **Убедитесь, что Docker и Docker Compose установлены.**
2.  **Создайте `docker-compose.yml`** (если его еще нет). Пример был предоставлен в ходе нашей переписки. Он должен включать сервисы для вашего приложения, PostgreSQL и Redis.
3.  **Создайте файл `.env`** в корне проекта (на одном уровне с `docker-compose.yml`). Заполните его переменными окружения для Docker (см. пример ранее, `DB_HOST` должен указывать на имя сервиса БД в Docker Compose, например `db`). Установите `MODE=PROD` или `MODE=DEV`.
4.  **Соберите и запустите контейнеры:**
    ```bash
    docker-compose up --build -d
    ```
5.  **Примените миграции** (если это первый запуск или были изменения схемы):
    Вы можете выполнить это, подключившись к запущенному контейнеру приложения или добавив команду в `docker-compose.yml` или `entrypoint.sh`.
    Пример подключения к контейнеру (замените `<имя_сервиса_приложения>` на имя вашего контейнера приложения из `docker-compose.yml`):
    ```bash
    docker-compose exec <имя_сервиса_приложения> alembic upgrade head
    ```
    Приложение будет доступно по порту, указанному в `docker-compose.yml` (например, `http://localhost:7777`, если вы пробрасывали порт `7777:8000`).

## Тестирование

Для запуска тестов используйте Pytest. Убедитесь, что у вас настроен файл `.env-test` с конфигурацией для тестовой среды (включая `MODE=TEST` и отдельную тестовую БД).

Активируйте виртуальное окружение Poetry:
```bash
poetry shell
```
Запустите тесты:
```bash
pytest
```
Или с большей детализацией:
```bash
pytest -s -v
```

## API Документация

После запуска приложения FastAPI автоматически генерирует интерактивную API документацию:

*   **Swagger UI**: доступен по адресу `http://localhost:8000/docs` (замените порт, если необходимо).
*   **ReDoc**: доступен по адресу `http://localhost:8000/redoc`.

## Дальнейшие шаги и улучшения (TODO)

*   [ ] Добавить более детальное логирование.
*   [ ] Настроить CI/CD для автоматической сборки, тестирования и развертывания.
*   [ ] Усилить безопасность (например, более строгие политики CORS для продакшена, лимиты запросов).
*   [ ] Расширить административные функции.
*   [ ] Добавить больше интеграционных и e2e тестов.

---

Автор: [Ваше Имя/Название Компании]
