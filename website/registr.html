<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" >
    <title>–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</title>
    <link rel="stylesheet" href="css/style_registr.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: Comic Sans MS, Comic Sans, cursive;
            margin:0px;
            padding: 0px;
            background-color: #3A3A3A
        }
    </style>
</head>
<body>
    <div class="header2">
        <div class="logo">
            <a href="basic.html"><img src="img/–∑–ª–æ–π —Ä—É—Å.png" class="zloy" alt="–ó–ª–æ–π –†—É—Å—Å–∫–∏–π"></a>
        </div>
        <div class="menu">
            <a href="oge.html">–û–ì–≠</a>
            <a href="ege.html">–ï–ì–≠</a>
            <a href="materials.html"><b>–ú–ê–¢–ï–†–ò–ê–õ–´ –î–õ–Ø –£–†–û–ö–û–í</b></a>
        </div>
        <div class="buttons">
            <button class="menu-button">
                <img src="img/–ø–∂.png" style="width: 50px;" alt="–ü–ñ">
            </button>
            <button class="hamburger-button" onclick="toggleMenu()">
                <img src="img/new_hambur.png" style="margin: -18px 0px 10px -10px; width: 50px;" alt="–∫–Ω–æ–ø–∫–∞ –±—É—Ä–≥–µ—Ä">
            </button>
        </div>
    </div>

    <h1 style="color: #DA1984; font-family: 'Arial', sans-serif;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>

    <div class="phone-input">
        <input type="text" id="phone-input" class="phone-number" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
    </div>

    <div class="phone-input">
        <input type="text" id="code-phone" class="phone-number" placeholder="–ö–æ–¥/—Ç–µ–ª–µ—Ñ–æ–Ω">
    </div>

    <div class="form-group">
        <input
            type="email"
            id="email-input"
            class="text-input"
            placeholder="Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
            data-placeholder-focus="example@mail.com"
        >
    </div>

    <div class="phone-input">
        <input type="text" id="code-email" class="phone-number" placeholder="–ö–æ–¥/email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
    </div>

    <div class="form-group">
        <div class="password-container">
            <input
                type="text"
                id="password"
                inputmode="password"
                class="text-input password-input"
                placeholder="–ü–∞—Ä–æ–ª—å"
            >
            <button class="toggle-password" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å" type="button">
                <span class="eye-icon">üëÅÔ∏è</span>
            </button>
        </div>
    </div>
    <div style="display: flex; margin-left: 130px;">
        <div class="form-group">
            <div class="password-container">
                <input
                    type="text"
                    id="password-repeat"
                    inputmode="password"
                    class="text-input password-input"
                    placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                >
                <button class="toggle-password" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å" type="button">
                    <span class="eye-icon">üëÅÔ∏è</span>
                </button>
            </div>
        </div>

        <div class="form-footer">
            <button type="button" id="submit-data" class="submit-icon-btn" style="margin-left: 50px; margin-bottom: 15px;">
                <img src="img/–∫–Ω–æ–ø–∫–∞—Ä–µ–≥.png" alt="–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é">
            </button>
        </div>
    </div>

    <div id="submit-error" style="color: red; margin-top: 10px;"></div>

    <button id="send-phone" style="color: #DA1984;
    background: none;
    border: none;
    text-decoration: underline;
    cursor: pointer;
    padding: 0;
    font-size: inherit; "><b><h2>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥/—Ç–µ–ª–µ—Ñ–æ–Ω</h2></b></button>

    <div id="phone-error" style="color: red; margin-top: 10px;"></div>

    <button id="send-email" style="color: #DA1984;
    background: none;
    border: none;
    text-decoration: underline;
    cursor: pointer;
    padding: 0;
    font-size: inherit; "><b><h2>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥/email</h2></b></button>

    <div id="email-error" style="color: red; margin-top: 10px;"></div>

        <b><h2 class="but_reg">–•–æ—Ç–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è? </h2></b>
    <a class="but_reg" href="login.html" style="color:#DA1984; margin-left: 30px;"><b><h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2></b></a>
    </div>

    <div style="display: flex;">
        <b><h2 class="but_reg">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</h2></b>
        <a class="but_reg" href="passrec.html" style="margin-left: 30px;
        color: #DA1984;"><b><h2>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å</h2></b></a>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.6/jquery.inputmask.min.js"></script>
    <script src="scripts/script.js"></script>

    <div class="full-width-line"></div>

    <div class="the_end" style="padding-top: 20px">
        <h1 style="flex: 1;
        text-align: center;"
        >–°–ª—É–∂–µ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h1>
        <img src="img/–∑–ª–æ–π —Ä—É—Å.png" class="zloy_ru" alt="–∑–ª–æ–π —Ä—É—Å">
    </div>




<script>
        function toggleMenu() {
            const menu = document.getElementById("dropdown");
            menu.classList.toggle("active");
        }

        document.addEventListener("click", function(event) {
            const menu = document.getElementById("dropdown");
            const hamburger = document.querySelector(".hamburger-button");
            if (menu.classList.contains("active") &&
                !menu.contains(event.target) &&
                !hamburger.contains(event.target)
            ) {
                menu.classList.remove("active");
            }
        });



        document.getElementById("send-phone").addEventListener("click", function () {
            const phoneInput = document.getElementById("phone-input");
            const rawPhone = phoneInput.value.trim();
            const cleanedPhone = rawPhone.replace(/\D/g, '');
            const errorDiv = document.getElementById("phone-error");

            if (!cleanedPhone) {
                errorDiv.textContent = "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.";
                return;
            } else if (cleanedPhone.length !== 11 || !/^7\d{10}$/.test(cleanedPhone)) {
                errorDiv.textContent = "–§–æ—Ä–º–∞—Ç: +7 (XXX) XXX-XX-XX";
                return;
            } else {
                errorDiv.textContent = "";
            }

            fetch("https://a824-185-153-181-236.ngrok-free.app/auth/register/phone_code", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ phone: "+" + cleanedPhone })
            })
            .then(async res => {
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData?.detail || `–û—à–∏–±–∫–∞: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                errorDiv.style.color = "green";
                errorDiv.textContent = "–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!";
            })
            .catch(err => {
                errorDiv.style.color = "red";
                errorDiv.textContent = err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥.";
            });
        });

        document.getElementById("send-email").addEventListener("click", function () {
            const emailInput = document.getElementById("email-input");
            const email = emailInput.value.trim();
            const errorDiv = document.getElementById("email-error");
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!email) {
                errorDiv.textContent = "–í–≤–µ–¥–∏—Ç–µ email.";
                return;
            } else if (!emailRegex.test(email)) {
                errorDiv.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email.";
                return;
            } else {
                errorDiv.textContent = "";
            }

            fetch("https://a824-185-153-181-236.ngrok-free.app/auth/register/email_code", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: email })
            })
            .then(async res => {
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData?.detail || `–û—à–∏–±–∫–∞: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                errorDiv.style.color = "green";
                errorDiv.textContent = "–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ email!";
            })
            .catch(err => {
                errorDiv.style.color = "red";
                errorDiv.textContent = err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥.";
            });
        });

        document.getElementById("submit-data").addEventListener("click", async () => {
            const rawPhone = document.getElementById("phone-input")?.value.trim();
            const cleanedPhone = rawPhone.replace(/\D/g, '');
            const email = document.getElementById("email-input")?.value.trim();
            const codePhone = document.getElementById("code-phone")?.value.trim();
            const codeEmail = document.getElementById("code-email")?.value.trim();
            const password = document.getElementById("password")?.value;
            const passwordRepeat = document.getElementById("password-repeat")?.value;

            const errorBlock = document.getElementById("submit-error");
            errorBlock.textContent = "";

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!cleanedPhone || cleanedPhone.length !== 11 || !/^7\d{10}$/.test(cleanedPhone)) {
                errorBlock.textContent = "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.";
                return;
            }
            if (email && !emailRegex.test(email)) {
                errorBlock.textContent = "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email.";
                return;
            }
            if (!codePhone) {
                errorBlock.textContent = "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞.";
                return;
            }
            if (email && !codeEmail) {
                errorBlock.textContent = "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è email.";
                return;
            }
            if (!password || password.length < 8) {
                errorBlock.textContent = "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤.";
                return;
            }
            if (password !== passwordRepeat) {
                errorBlock.textContent = "–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç.";
                return;
            }

            const payload = {
                phone: "+" + cleanedPhone,
                code_phone: codePhone,
                password,
                password_repeat: passwordRepeat
            };

            if (email) {
                payload.email = email;
                payload.code_email = codeEmail;
            }

            try {
                const response = await fetch("https://a824-185-153-181-236.ngrok-free.app/auth/register/verify", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    errorBlock.textContent = errorData.detail || "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.";
                } else {
                    window.location.href = "login.html";
                }
            } catch (err) {
                errorBlock.textContent = `–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${err.message}`;
            }
        });
    </script>


    <div class="dropdown" id="dropdown">
        <span class="close" onclick="toggleMenu()">&times;</span>
        <a href="login.html">–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è/–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
        <a href="questions.html">–æ—Ç–∑—ã–≤—ã</a>
        <a href="#">–æ –Ω–∞—Å</a>
        <a href="#">FAQ</a>
    </div>


</body>